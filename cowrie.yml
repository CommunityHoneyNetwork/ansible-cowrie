---
  - hosts: all

    tasks:
      - name: Gather | print os info
        debug:
          msg: "{{ ansible_distribution }}-{{ ansible_distribution_major_version}}"

      - name: Gather | os info
        include_vars: "{{ item }}"
        with_first_found:
          - "{{ ansible_distribution }}-{{ ansible_distribution_major_version}}.yml"
          - "{{ ansible_distribution }}.yml"
        tags: vars

      - name: Gather | default info
        include_vars:
          file: default.yml
        tags: vars

      - name: install non-specific packages
        package:
          name: "{{ item }}"
        with_items: "{{ pkgs }}"

      - name: install os-specific packages
        package:
          name: "{{ item }}"
        with_items: "{{ pkgs_osspec }}"

      - name: add users group
        group:
          name: users

      - name: create cowrie user
        user:
          name: cowrie
          shell: /bin/bash
          group: users

      - name: clone cowrie source
        git:
          repo: "{{ cowrie_repo }}"
          version: "{{ cowrie_version }}"
          dest: /opt/cowrie

      - name: install cowrie
        pip:
          requirements: /opt/cowrie/requirements.txt
          virtualenv: /opt/cowrie/cowrie-env

      - name: set file perms
        file:
          path: "{{ cowrie_dir }}"
          owner: "{{ cowrie_user }}"
          group: root

      - name: add supervisor config
        copy:
          src: cowrie.conf
          dest: "{{ supervisor_confdir }}/cowrie.ini"
